import { Link } from 'react-router';
import {
  User,
  Phone,
  Mail,
  MapPin,
  Network,
  Target,
  Plus,
  Edit2,
  X,
  Save,
  Trash2,
} from 'lucide-react';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from '~/common/components/ui/card';
import { Button } from '~/common/components/ui/button';
import { Badge } from '~/common/components/ui/badge';
import { Input } from '~/common/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '~/common/components/ui/select';
import { Separator } from '~/common/components/ui/separator';
import {
  getClientCardStyle,
  getImportanceBadge,
  getTranslatedStageName,
  IMPORTANCE_OPTIONS,
  TELECOM_PROVIDER_OPTIONS,
  calculateAge,
  calculateBMI,
  getBMIStatus,
} from '../lib/client-detail-utils';
import type { ClientDetailProfile } from '../types/client-detail';
import { useState, useMemo } from 'react';
import { useHydrationSafeTranslation } from '~/lib/i18n/use-hydration-safe-translation';

interface ClientSidebarProps {
  client: ClientDetailProfile | null;
  isEditing: boolean;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  editFormData: Record<string, any>;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  setEditFormData: React.Dispatch<React.SetStateAction<any>>;
  handleEditStart: () => void;
  handleEditSave: () => void;
  handleEditCancel: () => void;
  // eslint-disable-next-line no-unused-vars
  handleSsnChange: (_ssnFront: string, _ssnBack: string) => void;
  clientTags: Array<{ id: string; name: string; color: string }>;
  handleOpenTagModal: () => void;
  // eslint-disable-next-line no-unused-vars
  removeClientTag: (_tagId: string) => void;
  availableReferrers?: Array<{ id: string; name: string }>; // ÏÜåÍ∞úÏûê ÌõÑÎ≥¥ Î™©Î°ù
  onDeleteClient: () => void; // Í≥†Í∞ù ÏÇ≠Ï†ú ÏΩúÎ∞±
}

export function ClientSidebar({
  client,
  isEditing,
  editFormData,
  setEditFormData,
  handleEditStart,
  handleEditSave,
  handleEditCancel,
  handleSsnChange,
  clientTags,
  handleOpenTagModal,
  removeClientTag,
  availableReferrers = [], // ÏÜåÍ∞úÏûê ÌõÑÎ≥¥ Î™©Î°ù
  onDeleteClient,
}: ClientSidebarProps) {
  const { t } = useHydrationSafeTranslation('clients');

  const cardStyle = getClientCardStyle(client?.importance || 'medium');

  // BMI Í≥ÑÏÇ∞ Î°úÏßÅ
  const currentBMI =
    client?.height && client?.weight
      ? calculateBMI(client.height.toString(), client.weight.toString())
      : null;

  const editingBMI =
    isEditing && editFormData.height && editFormData.weight
      ? calculateBMI(
          editFormData.height.toString(),
          editFormData.weight.toString()
        )
      : null;

  // üåç ÏßÅÏ†ë ÏûÖÎ†• ÌÜµÏã†ÏÇ¨Î•º ÏúÑÌïú ÏÉÅÌÉú
  const [isCustomTelecom, setIsCustomTelecom] = useState(false);
  const [customTelecomProvider, setCustomTelecomProvider] = useState('');

  // üîÑ Ìé∏Ïßë Î™®Îìú ÏÉÅÌÉúÏóê Îî∞Î•∏ ÌÜµÏã†ÏÇ¨ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
  useMemo(() => {
    if (isEditing) {
      // Ìé∏Ïßë Î™®Îìú ÏßÑÏûÖ Ïãú, ÌòÑÏû¨ Í∞íÏù¥ Í∏∞Î≥∏ ÏòµÏÖòÏóê ÏóÜÏúºÎ©¥ ÏßÅÏ†ë ÏûÖÎ†•ÏúºÎ°ú Í∞ÑÏ£º
      const isInDefaultOptions = TELECOM_PROVIDER_OPTIONS.some(
        option => option.value === editFormData.telecomProvider
      );
      if (
        !isInDefaultOptions &&
        editFormData.telecomProvider &&
        editFormData.telecomProvider !== 'none'
      ) {
        setIsCustomTelecom(true);
        setCustomTelecomProvider(editFormData.telecomProvider);
      } else {
        setIsCustomTelecom(false);
        setCustomTelecomProvider('');
      }
    } else {
      // Ìé∏Ïßë Î™®Îìú Ï¢ÖÎ£å Ïãú ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      setIsCustomTelecom(false);
      setCustomTelecomProvider('');
    }
  }, [isEditing, editFormData.telecomProvider]);

  return (
    <div className="lg:col-span-1 mb-6">
      <div className="relative">
        <Card
          className={`sticky top-6 border-border/50 ${cardStyle.bgGradient} ${cardStyle.borderClass} overflow-hidden`}
        >
          <CardHeader className="text-center pb-2">
            <div className="flex justify-between items-start mb-4">
              <div className="flex-1" />
              <div className="w-14 h-14 rounded-full bg-primary/10 flex items-center justify-center mx-auto">
                <User className="h-6 w-6 text-primary" />
              </div>
              <div className="flex-1 flex justify-end gap-2">
                {isEditing ? (
                  <div className="flex gap-2">
                    <Button
                      onClick={handleEditSave}
                      size="sm"
                      className="bg-primary hover:bg-primary/90 text-primary-foreground"
                    >
                      <Save className="h-4 w-4 mr-1" />
                      {t('header.save', 'Ï†ÄÏû•')}
                    </Button>
                    <Button
                      onClick={handleEditCancel}
                      size="sm"
                      variant="outline"
                    >
                      <X className="h-4 w-4 mr-1" />
                      {t('header.cancel', 'Ï∑®ÏÜå')}
                    </Button>
                  </div>
                ) : (
                  <>
                    <Button
                      onClick={handleEditStart}
                      size="sm"
                      variant="outline"
                      className="hover:bg-primary/10"
                      title={t('sidebar.editTooltip', 'Í≥†Í∞ù Ï†ïÎ≥¥ Ìé∏Ïßë')}
                    >
                      <Edit2 className="h-4 w-4" />
                    </Button>
                    <Button
                      onClick={onDeleteClient}
                      size="sm"
                      variant="outline"
                      className="hover:bg-red-50 hover:text-red-600 hover:border-red-200"
                      title={t('sidebar.deleteTooltip', 'Í≥†Í∞ù ÏÇ≠Ï†ú')}
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </>
                )}
              </div>
            </div>
            {isEditing ? (
              <div className="space-y-3">
                <div>
                  <label className="text-xs font-medium text-muted-foreground mb-1 block">
                    {t('fields.fullName', 'Í≥†Í∞ùÎ™Ö')}
                  </label>
                  <Input
                    value={editFormData.fullName}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        fullName: e.target.value,
                      })
                    }
                    className="text-center text-lg font-semibold"
                    placeholder={t('fields.fullName', 'Í≥†Í∞ùÎ™Ö')}
                  />
                </div>
                <div>
                  <label className="text-xs font-medium text-muted-foreground mb-1 block">
                    {t('fields.importance', 'Ï§ëÏöîÎèÑ')}
                  </label>
                  <Select
                    value={editFormData.importance}
                    onValueChange={(value: 'high' | 'medium' | 'low') =>
                      setEditFormData({
                        ...editFormData,
                        importance: value,
                      })
                    }
                  >
                    <SelectTrigger className="w-full">
                      <SelectValue
                        placeholder={t('fields.importance', 'Ï§ëÏöîÎèÑ')}
                      />
                    </SelectTrigger>
                    <SelectContent>
                      {IMPORTANCE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {t(option.labelKey, option.fallback)}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
            ) : (
              <>
                <CardTitle className="text-xl">
                  {client?.fullName || t('labels.client', 'Í≥†Í∞ù')}
                </CardTitle>
                <div className="flex justify-center">
                  {(() => {
                    const { style, text } = getImportanceBadge(
                      client?.importance || 'medium',
                      t
                    );
                    return <Badge className={style}>{text}</Badge>;
                  })()}
                </div>
              </>
            )}
          </CardHeader>

          <CardContent className="p-6 pt-3 space-y-4">
            {/* Ïó∞ÎùΩÏ≤ò Ï†ïÎ≥¥ */}
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <Phone className="h-4 w-4 text-muted-foreground" />
                {isEditing ? (
                  <Input
                    value={editFormData.phone}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        phone: e.target.value,
                      })
                    }
                    placeholder={t('fields.phone', 'Ï†ÑÌôîÎ≤àÌò∏')}
                    className="text-sm"
                  />
                ) : (
                  <span className="text-sm">
                    {client?.phone || t('sidebar.noInfo', 'Ï†ïÎ≥¥ ÏóÜÏùå')}
                  </span>
                )}
              </div>

              {/* Ïù¥Î©îÏùº */}
              <div className="flex items-center gap-3">
                <Mail className="h-4 w-4 text-muted-foreground" />
                {isEditing ? (
                  <Input
                    value={editFormData.email}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        email: e.target.value,
                      })
                    }
                    placeholder="email@example.com"
                    type="email"
                    className="text-sm"
                  />
                ) : (
                  <span className="text-sm">
                    {client?.email || (
                      <span
                        className="text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                        onClick={handleEditStart}
                        title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                      >
                        {t('sidebar.emailNotSet', 'Ïù¥Î©îÏùº ÎØ∏ÏûÖÎ†•')}
                      </span>
                    )}
                  </span>
                )}
              </div>

              {/* Ï£ºÏÜå - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-start gap-3">
                <MapPin className="h-4 w-4 text-muted-foreground mt-0.5" />
                {isEditing ? (
                  <Input
                    value={editFormData.address}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        address: e.target.value,
                      })
                    }
                    placeholder={t('fields.address', 'Ï£ºÏÜå')}
                    className="text-sm"
                  />
                ) : (
                  <span className="text-sm leading-relaxed">
                    {client?.address || (
                      <span
                        className="text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                        onClick={handleEditStart}
                        title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                      >
                        {t('sidebar.addressNotSet', 'Ï£ºÏÜå ÎØ∏ÏûÖÎ†•')}
                      </span>
                    )}
                  </span>
                )}
              </div>

              {/* ÏßÅÏóÖ - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-center gap-3">
                <User className="h-4 w-4 text-muted-foreground" />
                {isEditing ? (
                  <Input
                    value={editFormData.occupation}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        occupation: e.target.value,
                      })
                    }
                    placeholder={t('fields.occupation', 'ÏßÅÏóÖ')}
                    className="text-sm"
                  />
                ) : (
                  <span className="text-sm">
                    {client?.occupation || (
                      <span
                        className="text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                        onClick={handleEditStart}
                        title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                      >
                        {t('sidebar.occupationNotSet', 'ÏßÅÏóÖ ÎØ∏ÏûÖÎ†•')}
                      </span>
                    )}
                  </span>
                )}
              </div>

              {/* ÌÜµÏã†ÏÇ¨ Ï†ïÎ≥¥ - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex flex-col gap-3">
                <div className="flex items-center gap-3">
                  <span className="h-4 w-4 text-muted-foreground flex items-center justify-center">
                    üì±
                  </span>
                  {isEditing ? (
                    <div className="flex-1 space-y-2">
                      <Select
                        value={
                          isCustomTelecom
                            ? 'custom'
                            : editFormData.telecomProvider || 'none'
                        }
                        onValueChange={value => {
                          if (value === 'custom') {
                            setIsCustomTelecom(true);
                            // Í∏∞Ï°¥ Í∞íÏù¥ ÏûàÏúºÎ©¥ customTelecomProviderÏóê ÏÑ§Ï†ï
                            if (
                              editFormData.telecomProvider &&
                              editFormData.telecomProvider !== 'none'
                            ) {
                              setCustomTelecomProvider(
                                editFormData.telecomProvider
                              );
                            }
                          } else {
                            setIsCustomTelecom(false);
                            setCustomTelecomProvider('');
                            setEditFormData({
                              ...editFormData,
                              telecomProvider: value,
                            });
                          }
                        }}
                      >
                        <SelectTrigger className="text-sm">
                          <SelectValue
                            placeholder={t(
                              'sidebar.selectTelecom',
                              'ÌÜµÏã†ÏÇ¨ ÏÑ†ÌÉù'
                            )}
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {TELECOM_PROVIDER_OPTIONS.map(option => (
                            <SelectItem key={option.value} value={option.value}>
                              {t(option.labelKey, option.fallback)}
                            </SelectItem>
                          ))}
                          <SelectItem value="custom" className="font-medium">
                            üåç {t('sidebar.customTelecom', 'Í∏∞ÌÉÄ (ÏßÅÏ†ë ÏûÖÎ†•)')}
                          </SelectItem>
                        </SelectContent>
                      </Select>

                      {/* üåç ÏßÅÏ†ë ÏûÖÎ†• ÌïÑÎìú (Ï°∞Í±¥Î∂Ä ÌëúÏãú) */}
                      {isCustomTelecom && (
                        <div className="ml-6 space-y-1">
                          <Input
                            type="text"
                            placeholder={t(
                              'sidebar.telecomPlaceholder',
                              'ÌÜµÏã†ÏÇ¨Î™ÖÏùÑ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî'
                            )}
                            value={customTelecomProvider}
                            onChange={e => {
                              const value = e.target.value;
                              setCustomTelecomProvider(value);
                              setEditFormData({
                                ...editFormData,
                                telecomProvider: value,
                              });
                            }}
                            className="text-sm"
                          />
                          <p className="text-xs text-muted-foreground">
                            {t(
                              'sidebar.telecomExample',
                              'üí° Ïòà: Verizon, AT&T, T-Mobile, Vodafone Îì±'
                            )}
                          </p>
                        </div>
                      )}
                    </div>
                  ) : (
                    <span className="text-sm">
                      <span className="text-xs text-muted-foreground mr-2">
                        {t('sidebar.telecomLabel', 'ÌÜµÏã†ÏÇ¨')}
                      </span>
                      {client?.telecomProvider || (
                        <span
                          className="text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                          onClick={handleEditStart}
                          title={t('sidebar.clickToSelect', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù')}
                        >
                          {t('sidebar.notSelected', 'ÎØ∏ÏÑ†ÌÉù')}
                        </span>
                      )}
                    </span>
                  )}
                </div>
              </div>
            </div>

            <Separator />

            {/* ÌòÑÏû¨ Îã®Í≥Ñ - ÏúÑÎ°ú Ïù¥Îèô */}
            <div className="space-y-2">
              <h4 className="text-sm font-medium">
                {t('sidebar.currentStage', 'ÌòÑÏû¨ Îã®Í≥Ñ')}
              </h4>
              <Badge
                variant="outline"
                className="w-full justify-center h-10 text-md font-semibold"
              >
                {getTranslatedStageName(client?.currentStage?.name, t)}
              </Badge>
              {!client?.currentStage?.name && (
                <div className="text-xs text-muted-foreground bg-muted/20 p-2 rounded border-l-2 border-muted-foreground/30">
                  üí° <strong>{t('sidebar.notSet', 'ÎØ∏ÏÑ§Ï†ï')}</strong>
                  {t(
                    'sidebar.notInPipelineHelp',
                    'ÏùÄ ÏïÑÏßÅ ÏòÅÏóÖ ÌååÏù¥ÌîÑÎùºÏù∏Ïóê ÏßÑÏûÖÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÏûÖÎãàÎã§. "ÏÉà ÏòÅÏóÖ Í∏∞Ìöå" Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÌååÏù¥ÌîÑÎùºÏù∏Ïóê Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.'
                  )}
                </div>
              )}
            </div>

            <Separator />

            {/* Í∞úÏù∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ */}
            <div className="space-y-3">
              <h4 className="text-sm font-medium">
                {t('sidebar.personalInfo', 'Í∞úÏù∏ Ï†ïÎ≥¥')}
              </h4>

              {/* ÏÉùÎÖÑÏõîÏùº - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-center gap-3">
                <span className="text-sm text-muted-foreground min-w-[50px]">
                  {t('sidebar.birthDate', 'ÏÉùÎÖÑÏõîÏùº')}
                </span>
                {!isEditing ? (
                  client?.extendedDetails?.birthDate ? (
                    <div className="space-y-1">
                      <span className="text-sm">
                        {new Date(
                          client.extendedDetails.birthDate
                        ).toLocaleDateString('ko-KR')}
                      </span>
                      {/* 3Í∞ÄÏßÄ ÎÇòÏù¥ ÌëúÏãú */}
                      <div className="text-xs text-muted-foreground space-y-1">
                        <div>
                          {t('sidebar.standardAge', 'Îßå ÎÇòÏù¥')}:{' '}
                          {calculateAge(
                            new Date(client.extendedDetails.birthDate),
                            'standard'
                          )}
                          {t('sidebar.ageUnit', 'ÏÑ∏')}
                        </div>
                        <div>
                          {t('sidebar.koreanAge', 'ÌïúÍµ≠ ÎÇòÏù¥')}:{' '}
                          {calculateAge(
                            new Date(client.extendedDetails.birthDate),
                            'korean'
                          )}
                          {t('sidebar.ageUnit', 'ÏÑ∏')}
                        </div>
                        <div>
                          {t('sidebar.insuranceAge', 'Î≥¥Ìóò ÎÇòÏù¥')}:{' '}
                          {calculateAge(
                            new Date(client.extendedDetails.birthDate),
                            'insurance'
                          )}
                          {t('sidebar.ageUnit', 'ÏÑ∏')}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <span
                      className="text-sm text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                      onClick={handleEditStart}
                      title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                    >
                      {t('sidebar.birthDateNotSet', 'ÏÉùÎÖÑÏõîÏùº ÎØ∏ÏûÖÎ†•')}
                    </span>
                  )
                ) : (
                  <>
                    <div className="flex-1">
                      <Input
                        type="date"
                        value={editFormData.birthDate}
                        onChange={e =>
                          setEditFormData({
                            ...editFormData,
                            birthDate: e.target.value,
                          })
                        }
                        className="text-sm"
                      />
                      {/* ÏàòÏ†ï Ï§ë ÎÇòÏù¥ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
                      {editFormData.birthDate && (
                        <div className="mt-2 p-2 border rounded-md bg-muted/20">
                          <div className="text-xs text-foreground font-medium mb-1">
                            üìÖ {t('sidebar.agePreview', 'ÎÇòÏù¥ ÎØ∏Î¶¨Î≥¥Í∏∞')}:
                          </div>
                          <div className="text-xs space-y-1">
                            <div>
                              <span className="text-green-700 dark:text-green-400">
                                {t('sidebar.standardAge', 'Îßå ÎÇòÏù¥')}:
                              </span>
                              <span className="ml-1 font-medium text-foreground">
                                {calculateAge(
                                  new Date(editFormData.birthDate),
                                  'standard'
                                )}
                                {t('sidebar.ageUnit', 'ÏÑ∏')}
                              </span>
                            </div>
                            <div>
                              <span className="text-amber-700 dark:text-amber-400">
                                {t('sidebar.koreanAge', 'ÌïúÍµ≠ ÎÇòÏù¥')}:
                              </span>
                              <span className="ml-1 font-medium text-foreground">
                                {calculateAge(
                                  new Date(editFormData.birthDate),
                                  'korean'
                                )}
                                {t('sidebar.ageUnit', 'ÏÑ∏')}
                              </span>
                            </div>
                            <div>
                              <span className="text-blue-700 dark:text-blue-400">
                                {t('sidebar.insuranceAge', 'Î≥¥Ìóò ÎÇòÏù¥')}:
                              </span>
                              <span className="ml-1 font-medium text-foreground">
                                {calculateAge(
                                  new Date(editFormData.birthDate),
                                  'insurance'
                                )}
                                {t('sidebar.ageUnit', 'ÏÑ∏')}
                              </span>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </>
                )}
              </div>

              {/* ÏÑ±Î≥Ñ - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-center gap-3">
                <span className="text-sm text-muted-foreground min-w-[50px]">
                  {t('sidebar.gender', 'ÏÑ±Î≥Ñ')}
                </span>
                {!isEditing ? (
                  client?.extendedDetails?.gender ? (
                    <Badge variant="outline" className="text-xs">
                      {client.extendedDetails.gender === 'male'
                        ? t('sidebar.male', 'ÎÇ®ÏÑ±')
                        : t('sidebar.female', 'Ïó¨ÏÑ±')}
                    </Badge>
                  ) : (
                    <span
                      className="text-sm text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                      onClick={handleEditStart}
                      title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                    >
                      {t('sidebar.genderNotSet', 'ÏÑ±Î≥Ñ ÎØ∏ÏûÖÎ†•')}
                    </span>
                  )
                ) : (
                  <div className="flex gap-2">
                    <label className="flex items-center gap-1 cursor-pointer">
                      <input
                        type="radio"
                        name="gender"
                        value="male"
                        checked={editFormData.gender === 'male'}
                        onChange={e =>
                          setEditFormData({
                            ...editFormData,
                            gender: e.target.value,
                          })
                        }
                        className="text-xs"
                      />
                      <span className="text-xs">
                        {t('sidebar.male', 'ÎÇ®ÏÑ±')}
                      </span>
                    </label>
                    <label className="flex items-center gap-1 cursor-pointer">
                      <input
                        type="radio"
                        name="gender"
                        value="female"
                        checked={editFormData.gender === 'female'}
                        onChange={e =>
                          setEditFormData({
                            ...editFormData,
                            gender: e.target.value,
                          })
                        }
                        className="text-xs"
                      />
                      <span className="text-xs">
                        {t('sidebar.female', 'Ïó¨ÏÑ±')}
                      </span>
                    </label>
                  </div>
                )}
              </div>
            </div>

            <Separator />

            {/* Ïã†Ï≤¥ Ï†ïÎ≥¥ */}
            <div className="space-y-3">
              <h4 className="text-sm font-medium">
                {t('sidebar.bodyInfo', 'Ïã†Ï≤¥ Ï†ïÎ≥¥')}
              </h4>

              {/* ÌÇ§ - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-center gap-3">
                <span className="text-sm text-muted-foreground min-w-[40px]">
                  {t('sidebar.height', 'ÌÇ§')}
                </span>
                {isEditing ? (
                  <Input
                    type="number"
                    value={editFormData.height}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        height: e.target.value,
                      })
                    }
                    placeholder="170"
                    className="text-sm"
                  />
                ) : client?.height ? (
                  <span className="text-sm">
                    {client.height}
                    {t('sidebar.cmUnit', 'cm')}
                  </span>
                ) : (
                  <span
                    className="text-sm text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                    onClick={handleEditStart}
                    title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                  >
                    {t('sidebar.notEntered', 'ÎØ∏ÏûÖÎ†•')}
                  </span>
                )}
                {isEditing && (
                  <span className="text-xs text-muted-foreground">
                    {t('sidebar.cmUnit', 'cm')}
                  </span>
                )}
              </div>

              {/* Î™∏Î¨¥Í≤å - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-center gap-3">
                <span className="text-sm text-muted-foreground min-w-[40px]">
                  {t('sidebar.weight', 'Î™∏Î¨¥Í≤å')}
                </span>
                {isEditing ? (
                  <Input
                    type="number"
                    value={editFormData.weight}
                    onChange={e =>
                      setEditFormData({
                        ...editFormData,
                        weight: e.target.value,
                      })
                    }
                    placeholder="70"
                    className="text-sm"
                  />
                ) : client?.weight ? (
                  <span className="text-sm">
                    {client.weight}
                    {t('sidebar.kgUnit', 'kg')}
                  </span>
                ) : (
                  <span
                    className="text-sm text-muted-foreground italic cursor-pointer hover:text-foreground transition-colors"
                    onClick={handleEditStart}
                    title={t('sidebar.clickToInput', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûÖÎ†•')}
                  >
                    {t('sidebar.notEntered', 'ÎØ∏ÏûÖÎ†•')}
                  </span>
                )}
                {isEditing && (
                  <span className="text-xs text-muted-foreground">
                    {t('sidebar.kgUnit', 'kg')}
                  </span>
                )}
              </div>

              {/* BMI ÌëúÏãú - ÌÇ§ÏôÄ Î™∏Î¨¥Í≤åÍ∞Ä Î™®Îëê ÏûàÏùÑ ÎïåÎßå */}
              {((isEditing && editingBMI) || (!isEditing && currentBMI)) && (
                <div className="flex items-center gap-3">
                  <span className="text-sm text-muted-foreground min-w-[40px]">
                    {t('sidebar.bmi', 'BMI')}
                  </span>
                  <div className="flex flex-col gap-1">
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-medium">
                        {isEditing ? editingBMI : currentBMI}
                      </span>
                      <Badge
                        variant="outline"
                        className={`text-xs ${
                          getBMIStatus(
                            isEditing ? editingBMI! : currentBMI!,
                            // ÏÑ±Î≥Ñ Ï†ïÎ≥¥ Ï†ÑÎã¨ (ÏàòÏ†ï Ï§ëÏù¥Î©¥ editFormData, ÏïÑÎãàÎ©¥ clientÏóêÏÑú)
                            isEditing
                              ? editFormData.gender
                              : client?.extendedDetails?.gender
                          ).color
                        }`}
                      >
                        {
                          getBMIStatus(
                            isEditing ? editingBMI! : currentBMI!,
                            isEditing
                              ? editFormData.gender
                              : client?.extendedDetails?.gender
                          ).status
                        }
                      </Badge>
                    </div>
                    {/* ÏÑ±Î≥ÑÎ≥Ñ Í∏∞Ï§Ä ÌëúÏãú */}
                    <div className="text-xs text-muted-foreground">
                      {
                        getBMIStatus(
                          isEditing ? editingBMI! : currentBMI!,
                          isEditing
                            ? editFormData.gender
                            : client?.extendedDetails?.gender
                        ).detail
                      }
                    </div>
                  </div>
                </div>
              )}

              {/* Ïö¥Ï†Ñ Ïó¨Î∂Ä - Ìï≠ÏÉÅ ÌëúÏãú */}
              <div className="flex items-center gap-3">
                <span className="text-sm text-muted-foreground min-w-[40px]">
                  {t('sidebar.driving', 'Ïö¥Ï†Ñ')}
                </span>
                {isEditing ? (
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={editFormData.hasDrivingLicense}
                      onChange={e =>
                        setEditFormData({
                          ...editFormData,
                          hasDrivingLicense: e.target.checked,
                        })
                      }
                      className="rounded"
                    />
                    <span className="text-sm">
                      {t('sidebar.canDrive', 'Ïö¥Ï†Ñ Í∞ÄÎä•')}
                    </span>
                  </label>
                ) : (
                  <Badge
                    variant={
                      client?.hasDrivingLicense ? 'default' : 'secondary'
                    }
                    className="text-xs"
                  >
                    {client?.hasDrivingLicense !== undefined
                      ? client.hasDrivingLicense
                        ? t('sidebar.canDrive', 'Ïö¥Ï†Ñ Í∞ÄÎä•')
                        : t('sidebar.cannotDrive', 'Ïö¥Ï†Ñ Î∂àÍ∞Ä')
                      : t('sidebar.notSet', 'ÎØ∏ÏÑ§Ï†ï')}
                  </Badge>
                )}
              </div>
            </div>

            {/* Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏ ÏûÖÎ†• - ÏàòÏ†ï Î™®ÎìúÏóêÏÑúÎßå ÌëúÏãú */}
            {isEditing && (
              <>
                <Separator />
                <div className="space-y-4">
                  <h4 className="text-sm font-medium text-foreground flex items-center gap-2">
                    üîí {t('sidebar.sensitiveDataManagement', 'ÎØºÍ∞êÏ†ïÎ≥¥ Í¥ÄÎ¶¨')}
                  </h4>
                  <div className="border border-border rounded-lg p-4 bg-muted/30">
                    <div className="space-y-3">
                      <div className="flex items-center gap-2 mb-3">
                        <span className="text-xs font-medium text-foreground">
                          {t('sidebar.ssnLabel', 'Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏')}
                        </span>
                        <span className="text-xs text-amber-800 bg-amber-100 px-2 py-1 rounded border border-amber-200 dark:text-amber-300 dark:bg-amber-900/30 dark:border-amber-800">
                          ‚ö†Ô∏è {t('sidebar.sensitiveData', 'ÎØºÍ∞êÏ†ïÎ≥¥')}
                        </span>
                      </div>

                      {/* Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏ Î∂ÑÎ¶¨ ÏûÖÎ†• - Full Width */}
                      <div className="grid grid-cols-5 gap-2 items-center">
                        <Input
                          type="text"
                          placeholder="YYMMDD"
                          value={editFormData.ssnFront}
                          onChange={e => {
                            const value = e.target.value
                              .replace(/\D/g, '')
                              .slice(0, 6);
                            handleSsnChange(value, editFormData.ssnBack);
                          }}
                          className="col-span-2 text-center font-mono"
                          maxLength={6}
                        />
                        <span className="text-muted-foreground font-bold text-center">
                          -
                        </span>
                        <Input
                          type="text"
                          placeholder="1‚óè‚óè‚óè‚óè‚óè‚óè"
                          value={editFormData.ssnBack}
                          onChange={e => {
                            const value = e.target.value
                              .replace(/\D/g, '')
                              .slice(0, 7);
                            handleSsnChange(editFormData.ssnFront, value);
                          }}
                          className="col-span-2 text-center font-mono"
                          maxLength={7}
                        />
                      </div>

                      {/* Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏ ÏûÖÎ†• ÎèÑÏõÄÎßê */}
                      <div className="text-xs text-muted-foreground bg-amber-50 dark:bg-amber-900/20 p-2 rounded border border-amber-200 dark:border-amber-800">
                        <div className="space-y-1">
                          <div className="flex items-center gap-1">
                            <span>‚ÑπÔ∏è</span>
                            <span className="font-medium">
                              {t(
                                'sidebar.ssnAutoCalculate',
                                'Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏ ÏûÖÎ†• Ïãú ÏûêÎèôÏúºÎ°ú ÏÉùÎÖÑÏõîÏùºÏù¥ Í≥ÑÏÇ∞Îê©ÎãàÎã§.'
                              )}
                            </span>
                          </div>
                          <div className="text-xs text-amber-700 dark:text-amber-300">
                            ‚Ä¢{' '}
                            {t(
                              'sidebar.ssnFrontHelp',
                              'ÏïûÏûêÎ¶¨: ÏÉùÎÖÑÏõîÏùº 6ÏûêÎ¶¨ (YYMMDD)'
                            )}
                          </div>
                          <div className="text-xs text-amber-700 dark:text-amber-300">
                            ‚Ä¢{' '}
                            {t(
                              'sidebar.ssnBackHelp',
                              'Îí∑ÏûêÎ¶¨: ÏÑ±Î≥Ñ Î∞è ÏÑ∏Í∏∞ Ìè¨Ìï® 7ÏûêÎ¶¨'
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}

            <Separator />

            {/* ÏÜåÍ∞ú Ï†ïÎ≥¥ */}
            <div className="space-y-3">
              <h4 className="text-sm font-medium">
                {t('sidebar.referralInfo', 'ÏÜåÍ∞ú Ï†ïÎ≥¥')}
              </h4>

              {/* ÎàÑÍ∞Ä Ïù¥ Í≥†Í∞ùÏùÑ ÏÜåÍ∞úÌñàÎäîÏßÄ */}
              <div className="flex items-center gap-3">
                <Network className="h-4 w-4 text-muted-foreground" />
                <div className="flex-1">
                  <div className="text-xs text-muted-foreground mb-1">
                    {t('sidebar.whoReferredClient', 'Ïù¥ Í≥†Í∞ùÏùÑ ÏÜåÍ∞úÌïú ÏÇ¨Îûå')}
                  </div>
                  {isEditing ? (
                    <div className="space-y-2">
                      <Select
                        value={editFormData.referredById || 'none'}
                        onValueChange={value => {
                          const actualValue =
                            value === 'none' ? undefined : value;
                          setEditFormData({
                            ...editFormData,
                            referredById: actualValue,
                          });
                        }}
                      >
                        <SelectTrigger className="w-full text-sm">
                          <SelectValue
                            placeholder={t(
                              'sidebar.selectReferrer',
                              'ÏÜåÍ∞úÏûê ÏÑ†ÌÉù'
                            )}
                          />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="none">
                            {t(
                              'sidebar.directDevelopment',
                              'ÏßÅÏ†ë Í∞úÎ∞ú (ÏÜåÍ∞úÏûê ÏóÜÏùå)'
                            )}
                          </SelectItem>
                          {/* Ïã§Ï†ú Í≥†Í∞ù Î™©Î°ù Î†åÎçîÎßÅ */}
                          {availableReferrers.map(referrer => (
                            <SelectItem key={referrer.id} value={referrer.id}>
                              {referrer.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <div className="text-xs text-muted-foreground bg-blue-50 dark:bg-blue-900/20 p-2 rounded border border-blue-200 dark:border-blue-800">
                        <div className="flex items-center gap-1">
                          <span>üí°</span>
                          <span>
                            {t(
                              'sidebar.referrerChangeHelp',
                              'ÏÜåÍ∞úÏûêÎ•º Î≥ÄÍ≤ΩÌïòÎ©¥ ÏÜåÍ∞ú ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.'
                            )}
                          </span>
                        </div>
                      </div>
                    </div>
                  ) : client?.referredBy ? (
                    <div className="flex items-center gap-2">
                      <Link
                        to={`/clients/${client.referredBy.id}`}
                        className="text-sm text-primary hover:underline font-medium"
                      >
                        {client.referredBy.name}
                      </Link>
                      <Badge variant="outline" className="text-xs">
                        {t('sidebar.referrerBadge', 'ÏÜåÍ∞úÏûê')}
                      </Badge>
                    </div>
                  ) : (
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-muted-foreground">
                        {t('sidebar.directClient', 'ÏßÅÏ†ë Í∞úÎ∞ú Í≥†Í∞ù')}
                      </span>
                      <Badge variant="secondary" className="text-xs">
                        {t('sidebar.newDevelopment', 'Ïã†Í∑ú Í∞úÎ∞ú')}
                      </Badge>
                    </div>
                  )}
                </div>
              </div>

              {/* Ïù¥ Í≥†Í∞ùÏù¥ ÏÜåÍ∞úÌïú Îã§Î•∏ Í≥†Í∞ùÎì§ */}
              <div className="flex items-start gap-3">
                <Network className="h-4 w-4 text-muted-foreground mt-1" />
                <div className="flex-1">
                  <div className="text-xs text-muted-foreground mb-1">
                    {t('sidebar.clientsReferredBy', 'Ïù¥ Í≥†Í∞ùÏù¥ ÏÜåÍ∞úÌïú ÏÇ¨ÎûåÎì§')}
                  </div>
                  {client?.referredClients &&
                  client.referredClients.length > 0 ? (
                    <div className="space-y-2">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-sm font-medium">
                          {t('sidebar.totalReferrals', 'Ï¥ù {{count}}Î™Ö ÏÜåÍ∞ú', {
                            count: client.referralCount,
                          })}
                        </span>
                        <Badge
                          variant="default"
                          className="text-xs bg-green-100 text-green-700 border-green-300"
                        >
                          {t('sidebar.referralContributor', 'ÏÜåÍ∞ú Í∏∞Ïó¨Ïûê')}
                        </Badge>
                      </div>
                      {/* Ïã§Ï†ú ÏÜåÍ∞úÌïú ÏÇ¨ÎûåÎì§ Ïù¥Î¶Ñ Î™©Î°ù */}
                      <div className="space-y-1">
                        {client.referredClients.map(
                          (
                            referredClient: {
                              id: string;
                              name: string;
                              createdAt: string;
                            },
                            index: number
                          ) => (
                            <div
                              key={referredClient.id}
                              className="flex items-center gap-2"
                            >
                              <Link
                                to={`/clients/${referredClient.id}`}
                                className="text-sm text-primary hover:underline font-medium"
                              >
                                {index + 1}. {referredClient.name}
                              </Link>
                              <Badge variant="outline" className="text-xs">
                                {new Date(
                                  referredClient.createdAt
                                ).toLocaleDateString('ko-KR')}
                              </Badge>
                            </div>
                          )
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-muted-foreground">
                        {t(
                          'sidebar.noReferralsYet',
                          'ÏïÑÏßÅ ÏÜåÍ∞úÌïú Í≥†Í∞ùÏù¥ ÏóÜÏäµÎãàÎã§'
                        )}
                      </span>
                      <Badge variant="outline" className="text-xs">
                        {t('sidebar.potentialReferrer', 'Ïû†Ïû¨ ÏÜåÍ∞úÏûê')}
                      </Badge>
                    </div>
                  )}
                </div>
              </div>
            </div>

            <Separator />

            {/* ÌÉúÍ∑∏ ÏÑπÏÖò */}
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <h4 className="text-sm font-medium">
                  {t('sidebar.tags', 'ÌÉúÍ∑∏')}
                </h4>
                {clientTags.length > 0 && (
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={handleOpenTagModal}
                    className="h-6 text-xs"
                  >
                    <Edit2 className="h-3 w-3 mr-1" />
                    {t('header.edit', 'Ìé∏Ïßë')}
                  </Button>
                )}
              </div>
              <div className="flex flex-wrap gap-2">
                {clientTags.length > 0 ? (
                  clientTags.map(tag => (
                    <Badge
                      key={tag.id}
                      variant="secondary"
                      className="text-xs cursor-pointer hover:bg-secondary/80 group relative"
                      style={{
                        backgroundColor: `${tag.color}20`,
                        borderColor: tag.color,
                      }}
                    >
                      <span style={{ color: tag.color }}>{tag.name}</span>
                      <button
                        onClick={e => {
                          e.stopPropagation();
                          removeClientTag(tag.id);
                        }}
                        className="ml-2 opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <X className="h-2 w-2" />
                      </button>
                    </Badge>
                  ))
                ) : (
                  <div className="text-center py-3 w-full">
                    <Target className="h-5 w-5 text-muted-foreground mx-auto mb-2" />
                    <p className="text-xs text-muted-foreground mb-2">
                      {t('sidebar.noTags', 'ÌÉúÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§')}
                    </p>
                    <Button
                      variant="outline"
                      size="sm"
                      className="text-xs h-7"
                      onClick={handleOpenTagModal}
                    >
                      <Plus className="h-3 w-3 mr-1" />
                      {t('sidebar.addTag', 'ÌÉúÍ∑∏ Ï∂îÍ∞Ä')}
                    </Button>
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
