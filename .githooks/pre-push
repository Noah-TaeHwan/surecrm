#!/bin/bash

# ğŸš€ SureCRM ìë™ íŒ¨ì¹˜ ë²„ì „ ì—…ë°ì´íŠ¸ Hook
# Git push ì‹œ íŒ¨ì¹˜ ë²„ì „ì„ ìë™ìœ¼ë¡œ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.

set -e

echo "ğŸ·ï¸ ìë™ íŒ¨ì¹˜ ë²„ì „ ì—…ë°ì´íŠ¸ ì¤‘..."

# í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
current_branch=$(git rev-parse --abbrev-ref HEAD)

# master ë¸Œëœì¹˜ê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ
if [ "$current_branch" != "master" ]; then
    echo "âœ… $current_branch ë¸Œëœì¹˜ëŠ” ë²„ì „ ì—…ë°ì´íŠ¸ë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
    exit 0
fi

# package.jsonì—ì„œ í˜„ì¬ ë²„ì „ ì½ê¸°
current_version=$(node -p "require('./package.json').version")
echo "ğŸ“¦ í˜„ì¬ ë²„ì „: $current_version"

# ë²„ì „ì´ ì´ë¯¸ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ìˆ˜ë™ ì—…ë°ì´íŠ¸ ê°ì§€)
last_commit_msg=$(git log -1 --pretty=%B)
if [[ $last_commit_msg == *"[version-update]"* ]]; then
    echo "âœ… ì´ë¯¸ ë²„ì „ì´ ì—…ë°ì´íŠ¸ëœ ì»¤ë°‹ì…ë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
    exit 0
fi

# ì‘ì—… ë””ë ‰í† ë¦¬ê°€ ê¹¨ë—í•œì§€ í™•ì¸
if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "âŒ ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì»¤ë°‹í•´ì£¼ì„¸ìš”."
    exit 1
fi

# íŒ¨ì¹˜ ë²„ì „ ìë™ ì¦ê°€
echo "ğŸ”„ íŒ¨ì¹˜ ë²„ì „ ìë™ ì¦ê°€ ì¤‘..."
npm version patch --no-git-tag-version > /dev/null

# ìƒˆ ë²„ì „ ì½ê¸°
new_version=$(node -p "require('./package.json').version")
echo "ğŸ‰ ìƒˆ ë²„ì „: $new_version"

# ë³€ê²½ì‚¬í•­ ì»¤ë°‹
git add package.json
git commit -m "ğŸ·ï¸ Auto-increment patch version to $new_version [version-update]

- ìë™ íŒ¨ì¹˜ ë²„ì „ ì—…ë°ì´íŠ¸
- ì´ì „ ë²„ì „: $current_version
- ìƒˆ ë²„ì „: $new_version
- ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"

# Git tag ìƒì„±
git tag "v$new_version"

echo "âœ… ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ: $current_version â†’ $new_version"
echo "ğŸ·ï¸ Git tag ìƒì„±: v$new_version"
echo "ï¿½ï¿½ í‘¸ì‹œë¥¼ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤..." 